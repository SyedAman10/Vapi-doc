<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bali Real Estate Assistant - Technical Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        .header {
            text-align: center;
            border-bottom: 3px solid #2c3e50;
            padding-bottom: 30px;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #7f8c8d;
            font-weight: 300;
        }

        .document-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 40px;
            border-left: 5px solid #3498db;
        }

        .document-info div {
            font-size: 0.9em;
            color: #666;
        }

        .document-info strong {
            color: #2c3e50;
        }

        .toc {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 40px;
        }

        .toc h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .toc ul {
            list-style: none;
        }

        .toc ul li {
            padding: 5px 0;
            border-bottom: 1px dotted #bdc3c7;
        }

        .toc ul li:last-child {
            border-bottom: none;
        }

        .toc a {
            text-decoration: none;
            color: #3498db;
            display: flex;
            justify-content: space-between;
        }

        .toc a:hover {
            color: #2980b9;
        }

        .section {
            margin-bottom: 40px;
            page-break-inside: avoid;
        }

        .section h2 {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .section h3 {
            color: #34495e;
            font-size: 1.4em;
            margin: 25px 0 15px 0;
        }

        .section h4 {
            color: #5d6d7e;
            font-size: 1.1em;
            margin: 20px 0 10px 0;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 6px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            position: relative;
        }

        .code-block::before {
            content: attr(data-lang);
            position: absolute;
            top: 5px;
            right: 10px;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.7em;
            text-transform: uppercase;
        }

        .inline-code {
            background: #f1f2f6;
            color: #e74c3c;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }

        .info-box {
            background: #e8f4fd;
            border-left: 5px solid #3498db;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #f39c12;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .feature-card h4 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .interface-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .interface-table th,
        .interface-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .interface-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }

        .interface-table tr:hover {
            background: #f8f9fa;
        }

        .footer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media print {
            body {
                padding: 20px;
            }
            .section {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Bali Real Estate Assistant</h1>
        <div class="subtitle">Technical Documentation & System Architecture</div>
    </div>

    <div class="document-info">
        <div><strong>Document Version:</strong> 1.0</div>
        <div><strong>Last Updated:</strong> June 2025</div>
        <div><strong>Technology Stack:</strong> Node.js, Express, VAPI SDK</div>
        <div><strong>Target Audience:</strong> Developers & System Architects</div>
    </div>

    <div class="toc">
        <h2>Table of Contents</h2>
        <ul>
            <li><a href="#overview">1. System Overview <span>Page 1</span></a></li>
            <li><a href="#architecture">2. System Architecture <span>Page 1</span></a></li>
            <li><a href="#dependencies">3. Dependencies & Requirements <span>Page 2</span></a></li>
            <li><a href="#class-structure">4. Class Structure & Interfaces <span>Page 2</span></a></li>
            <li><a href="#configuration">5. Configuration Management <span>Page 3</span></a></li>
            <li><a href="#webhooks">6. Webhook Integration <span>Page 4</span></a></li>
            <li><a href="#error-handling">7. Error Handling & Logging <span>Page 5</span></a></li>
            <li><a href="#security">8. Security Considerations <span>Page 5</span></a></li>
            <li><a href="#deployment">9. Deployment Guidelines <span>Page 6</span></a></li>
            <li><a href="#testing">10. Testing Framework <span>Page 6</span></a></li>
            <li><a href="#future">11. Future Enhancements <span>Page 7</span></a></li>
        </ul>
    </div>

    <section class="section" id="overview">
        <h2>1. System Overview</h2>
        <p>The Bali Real Estate Assistant is a sophisticated AI-powered conversational system designed to automate property inquiries and lead qualification processes. The system leverages advanced voice AI technology to conduct natural, human-like conversations with potential property buyers and investors.</p>
        
        <div class="info-box">
            <strong>Key Capabilities:</strong> Automated lead qualification, intelligent conversation flow management, real-time objection handling, and comprehensive analytics tracking.
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>Voice AI Integration</h4>
                <p>Seamless integration with VAPI for natural speech processing and voice synthesis capabilities.</p>
            </div>
            <div class="feature-card">
                <h4>Conversation Management</h4>
                <p>Dynamic conversation state tracking with intelligent response adaptation based on user interactions.</p>
            </div>
            <div class="feature-card">
                <h4>Lead Qualification</h4>
                <p>Automated assessment of prospect interest levels and property matching capabilities.</p>
            </div>
        </div>
    </section>

    <section class="section" id="architecture">
        <h2>2. System Architecture</h2>
        <p>The system follows a modular microservices architecture pattern, consisting of two primary components that work in conjunction to deliver a comprehensive conversational AI solution.</p>

        <h3>2.1 Core Components</h3>
        
        <h4>Express Server (server.js)</h4>
        <p>The Express server serves as the primary HTTP endpoint handler, responsible for processing incoming webhook requests, managing API routes, and coordinating communication between external services and the assistant logic.</p>

        <h4>Assistant Class (vapi-assistant.js)</h4>
        <p>The Assistant Class encapsulates all VAPI integration logic, conversation state management, and intelligent response generation. It maintains conversation context and adapts responses based on user interaction patterns.</p>

        <div class="warning-box">
            <strong>Performance Note:</strong> The current architecture stores conversation states in memory. For production deployments handling high traffic volumes, consider implementing persistent storage solutions.
        </div>
    </section>

    <section class="section" id="dependencies">
        <h2>3. Dependencies & Requirements</h2>
        
        <h3>3.1 Runtime Dependencies</h3>
        <div class="code-block" data-lang="json">
{
  "dependencies": {
    "@vapi-ai/server-sdk": "^1.0.0",
    "dotenv": "^16.0.0",
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "helmet": "^7.0.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.0",
    "jest": "^29.0.0",
    "@types/node": "^20.0.0"
  }
}</div>

        <h3>3.2 System Requirements</h3>
        <table class="interface-table">
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Minimum Requirement</th>
                    <th>Recommended</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Node.js Version</td>
                    <td>16.x</td>
                    <td>18.x or higher</td>
                </tr>
                <tr>
                    <td>Memory</td>
                    <td>512MB</td>
                    <td>1GB+</td>
                </tr>
                <tr>
                    <td>CPU</td>
                    <td>1 Core</td>
                    <td>2+ Cores</td>
                </tr>
                <tr>
                    <td>Network</td>
                    <td>Broadband</td>
                    <td>High-speed with low latency</td>
                </tr>
            </tbody>
        </table>
    </section>

    <section class="section" id="class-structure">
        <h2>4. Class Structure & Interfaces</h2>
        
        <h3>4.1 BaliRealEstateAssistant Class</h3>
        <div class="code-block" data-lang="typescript">
class BaliRealEstateAssistant {
    private vapi: VapiClient;
    private conversationStates: Map&lt;string, ConversationState&gt;;
    private assistantId: string | null;
    private readonly maxRetries: number = 3;
    private readonly timeoutMs: number = 30000;

    constructor(apiKey: string) {
        this.vapi = new VapiClient(apiKey);
        this.conversationStates = new Map();
        this.assistantId = null;
    }

    async createAssistant(): Promise&lt;Assistant&gt;;
    async updateAssistant(updates: AssistantUpdate): Promise&lt;Assistant&gt;;
    async initiateCall(phoneNumber: string, contactInfo: ContactInfo): Promise&lt;Call&gt;;
    async handleWebhook(event: WebhookEvent): Promise&lt;void&gt;;
    private getDynamicPrompt(sessionId: string, userMessage?: string): string;
    private analyzeResponse(message: string): ResponseAnalysis;
    private detectObjection(message: string): string | null;
}</div>

        <h3>4.2 Interface Definitions</h3>
        
        <h4>ConversationState Interface</h4>
        <div class="code-block" data-lang="typescript">
interface ConversationState {
    sessionId: string;
    stage: ConversationStage;
    interestLevel: InterestLevel | null;
    objections: ObjectionType[];
    contactInfo: ContactInformation;
    lastResponse: string | null;
    messages: ConversationMessage[];
    timestamp: Date;
    metadata: Record&lt;string, any&gt;;
}

type ConversationStage = 
    | 'opening' 
    | 'interest-assessment' 
    | 'property-discussion' 
    | 'objection-handling'
    | 'closing';

type InterestLevel = 'high' | 'medium' | 'low' | 'negative';</div>

        <h4>AssistantConfig Interface</h4>
        <div class="code-block" data-lang="typescript">
interface AssistantConfig {
    name: string;
    model: {
        provider: 'openai' | 'anthropic';
        model: string;
        temperature: number;
        maxTokens: number;
        messages: SystemMessage[];
    };
    voice: VoiceConfiguration;
    server: ServerConfiguration;
    serverMessages: string[];
    transportConfigurations: TransportConfig[];
    analytics: AnalyticsConfig;
}</div>
    </section>

    <section class="section" id="configuration">
        <h2>5. Configuration Management</h2>
        
        <h3>5.1 Environment Variables</h3>
        <div class="code-block" data-lang="bash">
# Core Configuration
VAPI_API_KEY=your_vapi_api_key_here
WEBHOOK_URL=https://your-domain.com/webhook
PORT=3000
NODE_ENV=production

# Security Configuration
JWT_SECRET=your_jwt_secret_here
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100

# Voice Configuration
DEFAULT_VOICE_ID=vapi_voice_id
SPEECH_RECOGNITION_LANGUAGE=en-US
VOICE_RESPONSE_TIMEOUT=5000

# Logging Configuration
LOG_LEVEL=info
LOG_FORMAT=json</div>

        <h3>5.2 Assistant Configuration Schema</h3>
        <p>The assistant configuration defines the behavior, voice characteristics, and operational parameters of the conversational AI system.</p>

        <div class="info-box">
            <strong>Configuration Best Practices:</strong> Store sensitive configuration data in environment variables, validate all configuration parameters on startup, and implement configuration hot-reloading for development environments.
        </div>
    </section>

    <section class="section" id="webhooks">
        <h2>6. Webhook Integration</h2>
        
        <h3>6.1 Supported Event Types</h3>
        <table class="interface-table">
            <thead>
                <tr>
                    <th>Event Type</th>
                    <th>Description</th>
                    <th>Payload Structure</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="inline-code">conversation-update</span></td>
                    <td>New user message received</td>
                    <td>Contains transcript and conversation context</td>
                </tr>
                <tr>
                    <td><span class="inline-code">speech-update</span></td>
                    <td>Real-time speech recognition updates</td>
                    <td>Partial and final transcription results</td>
                </tr>
                <tr>
                    <td><span class="inline-code">status-update</span></td>
                    <td>Call status changes</td>
                    <td>Status enum and metadata</td>
                </tr>
                <tr>
                    <td><span class="inline-code">end-of-call-report</span></td>
                    <td>Comprehensive call analytics</td>
                    <td>Full conversation summary and metrics</td>
                </tr>
            </tbody>
        </table>

        <h3>6.2 Webhook Event Processing</h3>
        <div class="code-block" data-lang="typescript">
async handleWebhook(event: WebhookEvent): Promise&lt;void&gt; {
    try {
        const sessionId = this.extractSessionId(event);
        const currentState = this.getOrCreateState(sessionId);
        
        switch (event.type) {
            case 'conversation-update':
                await this.processConversationUpdate(event, currentState);
                break;
            case 'speech-update':
                await this.processSpeechUpdate(event, currentState);
                break;
            case 'status-update':
                await this.processStatusUpdate(event, currentState);
                break;
            case 'end-of-call-report':
                await this.processCallComplete(event, currentState);
                break;
            default:
                console.warn(`Unhandled event type: ${event.type}`);
        }
    } catch (error) {
        console.error('Webhook processing error:', error);
        throw error;
    }
}</div>
    </section>

    <section class="section" id="error-handling">
        <h2>7. Error Handling & Logging</h2>
        
        <h3>7.1 Error Classification</h3>
        <div class="feature-grid">
            <div class="feature-card">
                <h4>Network Errors</h4>
                <p>Connection timeouts, DNS resolution failures, and network connectivity issues are handled with exponential backoff retry mechanisms.</p>
            </div>
            <div class="feature-card">
                <h4>API Errors</h4>
                <p>VAPI service errors are categorized by status code and handled appropriately with user-friendly error messages.</p>
            </div>
            <div class="feature-card">
                <h4>Validation Errors</h4>
                <p>Input validation failures are caught early and provide specific feedback about required corrections.</p>
            </div>
        </div>

        <h3>7.2 Logging Strategy</h3>
        <div class="code-block" data-lang="typescript">
// Structured logging implementation
const logger = {
    info: (message: string, data?: any) => {
        console.log(JSON.stringify({
            level: 'info',
            timestamp: new Date().toISOString(),
            message,
            data
        }));
    },
    
    error: (message: string, error?: Error, context?: any) => {
        console.error(JSON.stringify({
            level: 'error',
            timestamp: new Date().toISOString(),
            message,
            error: error?.message,
            stack: error?.stack,
            context
        }));
    }
};</div>
    </section>

    <section class="section" id="security">
        <h2>8. Security Considerations</h2>
        
        <h3>8.1 Authentication & Authorization</h3>
        <p>The system implements multiple layers of security to protect sensitive conversation data and prevent unauthorized access to the AI assistant functionality.</p>

        <div class="feature-grid">
            <div class="feature-card">
                <h4>API Token Security</h4>
                <p>VAPI API tokens are stored securely using environment variables and are never logged or exposed in error messages.</p>
            </div>
            <div class="feature-card">
                <h4>Webhook Validation</h4>
                <p>Incoming webhook requests are validated using cryptographic signatures to ensure authenticity.</p>
            </div>
            <div class="feature-card">
                <h4>Rate Limiting</h4>
                <p>Implementation of rate limiting prevents abuse and ensures system stability under high load conditions.</p>
            </div>
        </div>

        <h3>8.2 Data Protection</h3>
        <div class="warning-box">
            <strong>Privacy Compliance:</strong> Ensure all conversation data handling complies with applicable data protection regulations (GDPR, CCPA, etc.). Implement data retention policies and secure data deletion procedures.
        </div>
    </section>

    <section class="section" id="deployment">
        <h2>9. Deployment Guidelines</h2>
        
        <h3>9.1 Production Deployment Checklist</h3>
        <div class="code-block" data-lang="bash">
# 1. Environment Setup
export NODE_ENV=production
export VAPI_API_KEY=your_production_api_key
export WEBHOOK_URL=https://your-production-domain.com/webhook

# 2. Security Configuration
export JWT_SECRET=secure_random_string
export RATE_LIMIT_ENABLED=true

# 3. Performance Optimization
export NODE_OPTIONS="--max-old-space-size=1024"
export CLUSTER_WORKERS=4

# 4. Start Application
npm run start:production</div>

        <h3>9.2 Monitoring & Health Checks</h3>
        <p>Implement comprehensive monitoring to ensure system reliability and performance in production environments.</p>
    </section>

    <section class="section" id="testing">
        <h2>10. Testing Framework</h2>
        
        <h3>10.1 Test Structure</h3>
        <div class="code-block" data-lang="typescript">
describe('BaliRealEstateAssistant', () => {
    let assistant: BaliRealEstateAssistant;
    
    beforeEach(() => {
        assistant = new BaliRealEstateAssistant(process.env.TEST_API_KEY);
    });

    describe('Conversation Management', () => {
        it('should initialize conversation state correctly', async () => {
            const sessionId = 'test-session-123';
            const state = assistant.getConversationState(sessionId);
            expect(state.stage).toBe('opening');
            expect(state.interestLevel).toBeNull();
        });

        it('should handle conversation progression', async () => {
            // Test conversation flow progression
        });
    });

    describe('Webhook Processing', () => {
        it('should process conversation updates', async () => {
            // Test webhook event processing
        });
    });
});</div>

        <h3>10.2 Integration Testing</h3>
        <p>Comprehensive integration tests ensure proper communication between system components and external services.</p>
    </section>

    <section class="section" id="future">
        <h2>11. Future Enhancements</h2>
        
        <div class="feature-grid">
            <div class="feature-card">
                <h4>Persistent Storage</h4>
                <p>Implementation of database storage for conversation states, analytics, and long-term data persistence.</p>
            </div>
            <div class="feature-card">
                <h4>Advanced Analytics</h4>
                <p>Enhanced conversation analytics with machine learning insights and performance optimization recommendations.</p>
            </div>
            <div class="feature-card">
                <h4>Multi-language Support</h4>
                <p>Expansion to support multiple languages and regional dialects for international property markets.</p>
            </div>
            <div class="feature-card">
                <h4>CRM Integration</h4>
                <p>Direct integration with popular CRM systems for seamless lead management and follow-up automation.</p>
            </div>
            <div class="feature-card">
                <h4>Advanced Voice Options</h4>
                <p>Integration of custom voice models and emotional intelligence for more natural conversations.</p>
            </div>
            <div class="feature-card">
                <h4>Real-time Coaching</h4>
                <p>Live conversation coaching and suggestion system for continuous improvement of conversation quality.</p>
            </div>
        </div>
    </section>

    <div class="footer">
        <p><strong>Bali Real Estate Assistant Technical Documentation</strong></p>
        <p>Version 1.0 | June 2025 | Confidential & Proprietary</p>
    </div>
</body>
</html>
